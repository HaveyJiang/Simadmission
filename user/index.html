<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Experiment Portal</title>

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
        }

        .debug-box {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #222;
            color: #fff;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 4px;
            opacity: 0.85;
        }
    </style>
</head>

<body>

    <h2>User Portal Running…</h2>
    <p>
        This is your experiment UI placeholder.
        Your real experiment content goes here.
    </p>

    <div id="debug" class="debug-box">Sync: loading…</div>

    <script>
// ===============================================================
//  CONFIG
// ===============================================================

const SUPABASE_URL  = "https://mmpjvhlxqebznermjznl.supabase.co";
const SUPABASE_ANON = "YOUR-ANON-KEY-HERE";

// Local mirror for dev portal (optional)
function loadLocal(name, def) {
    const s = localStorage.getItem(name);
    return s ? JSON.parse(s) : def;
}
function saveLocal(name, val) {
    localStorage.setItem(name, JSON.stringify(val));
}

// BroadcastChannel for dev portal
const bc = ("BroadcastChannel" in self) ? new BroadcastChannel("exp-stream") : null;

// ===============================================================
// SESSION ID — guaranteed unique per participant
// ===============================================================

let sessionId = localStorage.getItem("session_id");
if (!sessionId) {
    sessionId = "S" + Date.now() + "-" + Math.floor(Math.random()*100000);
    localStorage.setItem("session_id", sessionId);
}

// ===============================================================
// ROBUST RELIABLE LOGGING LAYER
// ===============================================================

// --- 1. Persistent upload queue ---
const UPLOAD_KEY = "upload_queue_v2";

function loadQueue() {
    const raw = localStorage.getItem(UPLOAD_KEY);
    return raw ? JSON.parse(raw) : [];
}
function saveQueue(q) {
    localStorage.setItem(UPLOAD_KEY, JSON.stringify(q));
}

// --- 2. Convert client-side event to DB row ---
function eventToRow(evt) {
    return {
        ts: evt.ts,
        session_id: evt.session_id || sessionId,
        name: evt.name,
        channel: evt.channel || null,
        prolific_id: evt.prolific_id || null,
        case_index: evt.case_index ?? null,
        within_case_index: evt.within_case_index ?? null,
        route_code: evt.route_code ?? null,
        transcript_type: evt.transcript_type ?? null,
        letters: (evt.letters_shown_order || []).join(" "),
        slider_value: evt.slider_value ?? null,
        transcript_time_ms: evt.transcript_time_ms ?? null,
        payload: evt
    };
}

// --- 3. Upload queue → Supabase ---
async function flushUploadQueue() {
    const q = loadQueue();
    if (!q.length) {
        updateDebug("OK (empty)");
        return;
    }

    try {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/events`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "apikey": SUPABASE_ANON,
                "Authorization": `Bearer ${SUPABASE_ANON}`,
                "Prefer": "return=minimal"
            },
            body: JSON.stringify(q.map(x => x.row)),
            keepalive: true
        });

        if (!resp.ok) {
            updateDebug("Upload failed (" + resp.status + ")");
            return; // keep queue
        }

        // Success → clear queue
        localStorage.removeItem(UPLOAD_KEY);
        updateDebug("Synced " + q.length + " events");

    } catch (err) {
        updateDebug("Network error; queue kept");
    }
}

// Retry on reconnect
window.addEventListener("online", flushUploadQueue);

// ===============================================================
// MAIN EVENT LOGGER (called by UI)
// ===============================================================

function stream(evt) {
    evt.session_id = sessionId;
    evt.ts = evt.ts ?? Date.now();

    // 1. Local mirror for dev portal (same-device preview)
    const arr = loadLocal("exp_events", []);
    arr.push({ type: "event", ...evt });
    saveLocal("exp_events", arr);

    // 2. BroadcastChannel — dev portal updates live
    try { bc && bc.postMessage({ type: "event", ...evt }); } catch (_) {}

    // 3. Reliable DB upload
    const row = eventToRow(evt);
    const q = loadQueue();
    q.push({ row });
    saveQueue(q);
    flushUploadQueue();
}

// ===============================================================
// Debug widget showing queue status
// ===============================================================

function updateDebug(text) {
    const q = loadQueue();
    document.getElementById("debug").innerText =
        `Session ${sessionId}\nQueue: ${q.length}\n${text}`;
}

// Update debug every 2 seconds
setInterval(() => {
    updateDebug("running…");
    flushUploadQueue();
}, 2000);

// Initial update
updateDebug("starting…");

// ===============================================================
// Example event triggers (remove in final build)
// ===============================================================

setTimeout(() => {
    stream({ name: "session_meta", channel: "UserPortal" });
}, 1000);

    </script>

</body>
</html>
