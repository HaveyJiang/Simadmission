<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>User Portal</title><link rel="stylesheet" href="styles/style.css"></head><body><div id="app"></div><div class="mask"></div><script>(function(){const app=document.getElementById('app');const state={casesCount:8,maskMsMin:900,maskMsMax:1500,caseSliderDefault:50,introLines:['Initializing experimental interface...','Loading session environment...','Ready.']};const params=new URLSearchParams(location.search);const channel=(params.get('channel')==='Prolific')?'Prolific':'Others';const prolific_id=params.get('pid')||null;function el(t,a,c){const n=document.createElement(t);a=a||{};for(const k in a){if(k==='class')n.className=a[k];else if(k==='html')n.innerHTML=a[k];else n.setAttribute(k,a[k]);}(c||[]).forEach(x=>n.appendChild(typeof x==='string'?document.createTextNode(x):x));return n;}function fadeLines(container,lines,onDone){container.innerHTML='';const w=el('div',{class:'center'});container.appendChild(w);let i=0;(function step(){if(i>=lines.length){onDone&&onDone();return;}const d=el('div',{class:'fade'},[lines[i]]);w.appendChild(d);setTimeout(()=>d.classList.add('show'),50);i++;setTimeout(step,800);})();}function consentModal(ok,deny){app.innerHTML='';const box=el('div',{class:'card'},[el('h2',{},['Consent to Participate']),el('p',{},['Your responses will be uploaded for research use in real time.']),el('div',{class:'muted'},['You may decline; no data will be uploaded.']),el('div',{class:'btn-row'},[el('button',{id:'acc',class:'btn primary'},['Accept']),el('button',{id:'deny',class:'btn'},['Decline'])])]);const ctr=el('div',{class:'center'},[box]);app.appendChild(ctr);box.querySelector('#acc').onclick=ok;box.querySelector('#deny').onclick=deny;}function mask(msg){const m=document.querySelector('.mask');m.textContent=msg||'Loading…';m.classList.add('show');return()=>m.classList.remove('show');}function sliderRow(val,onCommit){const out=el('span',{class:'value'},[String(val)+'%']);const s=el('input',{type:'range',min:'0',max:'100',value:String(val),step:'1'});s.oninput=()=>{out.textContent=s.value+'%';};const btn=el('button',{class:'btn primary'},['Confirm']);btn.onclick=()=>onCommit(Number(s.value));return el('div',{class:'slider-row'},[el('label',{},['Assumed likelihood to pass this round:']),s,out,btn]);}function save(k,v){localStorage.setItem(k,JSON.stringify(v));}function load(k,d){const v=localStorage.getItem(k);return v?JSON.parse(v):d;}const bc=('BroadcastChannel'in self)?new BroadcastChannel('exp-stream'):null;function stream(e){const arr=load('exp_events',[]);arr.push({type:'event',...e});save('exp_events',arr);try{bc&&bc.postMessage({type:'event',...e});}catch(_){}}function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}function shuffle(a){a=a.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}function uniquePermutations(ms){const map={};ms.forEach(x=>map[x]=(map[x]||0)+1);const keys=Object.keys(map);const res=[];function bt(p){if(p.length===ms.length){res.push(p.slice());return;}for(const k of keys){if(map[k]>0){map[k]--;p.push(k);bt(p);p.pop();map[k]++;}}}bt([]);const seen=new Set(),out=[];for(const p of res){const s=p.join('');if(!seen.has(s)){seen.add(s);out.push(p);}}return out;}const ALPHA_ROWS=uniquePermutations(['A','A','A','B','B']);const BETA_ROWS=uniquePermutations(['A','A','B','B','B']);function routes(){const t=['A','B'],r=[];for(const i of t)for(const j of t)for(const k of t)r.push(i+j+k);return r;}const session={session_id:'S'+Date.now()+'-'+Math.floor(Math.random()*1e5),started_ts:Date.now(),upload_consent:null,finished:false,channel,prolific_id};save('last_channel',channel);if(prolific_id)save('last_pid',prolific_id);stream({name:'session_meta',session_id:session.session_id,ts:Date.now(),channel,prolific_id});const CASES=shuffle(routes()).slice(0,state.casesCount);let caseIdx=0,transIdx=0,caseStart=0,transStart=0,routeCode=null;let currentSlider=state.caseSliderDefault;const semesterTag=['X','Y','Z'];function startIntro(){const ctr=el('div',{class:'center'});app.innerHTML='';app.appendChild(ctr);fadeLines(ctr,state.introLines,()=>{const b=el('button',{class:'btn primary'},['Continue']);b.onclick=showConsent;ctr.appendChild(b);});}function showConsent(){consentModal(()=>{session.upload_consent=true;stream({name:'consent_accept',session_id:session.session_id,ts:Date.now()});startExperiment();},()=>{session.upload_consent=false;stream({name:'consent_decline',session_id:session.session_id,ts:Date.now()});app.innerHTML='<div class="center"><h2>Thank you for your time.</h2></div>';});}function startExperiment(){const un=mask('Preparing Case 1…');setTimeout(()=>{un();nextCase();},rand(state.maskMsMin,state.maskMsMax));}function nextCase(){if(caseIdx>=state.casesCount){finish();return;}routeCode=CASES[caseIdx];transIdx=0;caseStart=Date.now();currentSlider=state.caseSliderDefault;stream({name:'case_start',session_id:session.session_id,ts:caseStart,case_index:caseIdx+1,route_code:routeCode});nextTranscript();}function showTranscript(type,onCommit){app.innerHTML='';const row=(type==='A')?ALPHA_ROWS[Math.floor(Math.random()*ALPHA_ROWS.length)]:BETA_ROWS[Math.floor(Math.random()*BETA_ROWS.length)];const frame=el('div',{class:'card focus'});frame.appendChild(el('div',{class:'subhead'},['Semester ',['X','Y','Z'][transIdx]]));frame.appendChild(el('div',{class:'grades'},[row.join('   ')]));frame.appendChild(el('hr'));frame.appendChild(sliderRow(currentSlider,v=>onCommit({v,row})));app.appendChild(el('div',{class:'center'},[el('h2',{},['Case '+(caseIdx+1)+' — Transcript '+(transIdx+1)+'/3']),frame]));}function nextTranscript(){if(transIdx>=3){const caseTime=Date.now()-caseStart;stream({name:'case_end',session_id:session.session_id,ts:Date.now(),case_index:caseIdx+1,route_code:routeCode,case_time_ms:caseTime});caseIdx++;const un=mask('Loading next case…');setTimeout(()=>{un();nextCase();},rand(state.maskMsMin,state.maskMsMax));return;}const type=routeCode[transIdx];transStart=Date.now();showTranscript(type,({v,row})=>{const t=Date.now()-transStart;currentSlider=v;stream({name:'transcript_commit',session_id:session.session_id,ts:Date.now(),case_index:caseIdx+1,within_case_index:transIdx+1,route_code:routeCode,transcript_type:type,letters_shown_order:row,slider_value:v,transcript_time_ms:t});transIdx++;nextTranscript();});}function finish(){session.finished=true;stream({name:'session_finish',session_id:session.session_id,ts:Date.now(),finished:true});app.innerHTML='<div class="center"><h2>All cases complete.</h2><div class="muted">You may now close this window.</div></div>'; }startIntro();})();</script></body></html>