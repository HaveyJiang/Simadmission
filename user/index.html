<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>User Portal</title>
    <link rel="stylesheet" href="styles/style.css" />
</head>
<body>
    <div id="app"></div>
    <div class="mask"></div>

    <script>
        /* ========= CONFIG: UPDATE THESE TWO ========= */
        const SUPABASE_URL = 'https://mmpjvhlxqebznermjznl.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tcGp2aGx4cWViem5lcm1qem5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MTU5OTMsImV4cCI6MjA3ODQ5MTk5M30.GFmscoJGdD4zwLj4Fn-0hpMFXkdSIYUUo65MdLSfIkM';
        /* ============================================ */

        (function () {
            const app = document.getElementById('app');
            const maskEl = document.querySelector('.mask');

            const state = {
                casesCount: 8,
                maskMsMin: 900,
                maskMsMax: 1500,
                caseSliderDefault: 50,
                introLines: [
                    'Initializing experimental interface...',
                    'Loading session environment...',
                    'Ready.'
                ]
            };

            /* ---------- Basic helpers ---------- */

            function el(t, attrs, children) {
                const n = document.createElement(t);
                attrs = attrs || {};
                for (const k in attrs) {
                    if (k === 'class') n.className = attrs[k];
                    else if (k === 'html') n.innerHTML = attrs[k];
                    else n.setAttribute(k, attrs[k]);
                }
                (children || []).forEach(x =>
                    n.appendChild(typeof x === 'string' ? document.createTextNode(x) : x)
                );
                return n;
            }

            function save(k, v) {
                localStorage.setItem(k, JSON.stringify(v));
            }
            function load(k, d) {
                const v = localStorage.getItem(k);
                return v ? JSON.parse(v) : d;
            }

            function rand(a, b) {
                return Math.floor(Math.random() * (b - a + 1)) + a;
            }
            function shuffle(a) {
                a = a.slice();
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }

            function mask(msg) {
                maskEl.textContent = msg || 'Loading…';
                maskEl.classList.add('show');
                return () => maskEl.classList.remove('show');
            }

            function fadeLines(container, lines, onDone) {
                container.innerHTML = '';
                const w = document.createElement('div');
                w.className = 'center';
                container.appendChild(w);
                let i = 0;
                (function step() {
                    if (i >= lines.length) {
                        onDone && onDone();
                        return;
                    }
                    const d = el('div', { class: 'fade' }, [lines[i]]);
                    w.appendChild(d);
                    setTimeout(() => d.classList.add('show'), 50);
                    i++;
                    setTimeout(step, 800);
                })();
            }

            function sliderRow(val, onCommit) {
                const out = el('span', { class: 'value' }, [String(val) + '%']);
                const s = el('input', { type: 'range', min: '0', max: '100', value: String(val), step: '1' });
                s.oninput = () => { out.textContent = s.value + '%'; };
                const btn = el('button', { class: 'btn primary' }, ['Confirm']);
                btn.onclick = () => onCommit(Number(s.value));
                return el('div', { class: 'slider-row' }, [
                    el('label', {}, ['Assumed likelihood to pass this round:']),
                    s,
                    out,
                    btn
                ]);
            }

            /* ---------- Prolific / channel parsing ---------- */

            const qp = new URLSearchParams(location.search);
            const rawPid =
                qp.get('PROLIFIC_PID') ||
                qp.get('prolific_pid') ||
                qp.get('PID') ||
                qp.get('pid') ||
                null;
            const isTemplate = typeof rawPid === 'string' && /\{\{.*\}\}/.test(rawPid);
            let prolific_id = (!rawPid || isTemplate) ? null : rawPid;

            let channel = (qp.get('channel') === 'Prolific')
                ? 'Prolific'
                : (prolific_id ? 'Prolific' : 'Others');

            /* ---------- Session object ---------- */

            const session = {
                session_id: 'S' + Date.now() + '-' + Math.floor(Math.random() * 1e5),
                started_ts: Date.now(),
                upload_consent: null,
                finished: false,
                channel,
                prolific_id
            };

            /* ---------- Supabase upload queue (robust) ---------- */

            const UPLOAD_KEY = 'upload_queue_v2';

            function loadQueue() {
                const raw = localStorage.getItem(UPLOAD_KEY);
                return raw ? JSON.parse(raw) : [];
            }
            function saveQueue(q) {
                localStorage.setItem(UPLOAD_KEY, JSON.stringify(q));
            }

            function eventToRow(evt) {
                return {
                    ts: evt.ts,
                    session_id: evt.session_id ?? null,
                    name: evt.name,
                    channel: evt.channel ?? null,
                    prolific_id: evt.prolific_id ?? null,
                    case_index: evt.case_index ?? null,
                    within_case_index: evt.within_case_index ?? null,
                    route_code: evt.route_code ?? null,
                    transcript_type: evt.transcript_type ?? null,
                    letters: evt.letters_shown_order || [],
                    slider_value: evt.slider_value ?? null,
                    transcript_time_ms: evt.transcript_time_ms ?? null,
                    payload: evt
                };
            }

            async function flushUploadQueue() {
                if (!SUPABASE_URL || !SUPABASE_ANON ||
                    SUPABASE_URL.indexOf('supabase.co') === -1) return;

                const q = loadQueue();
                if (!q.length) return;

                try {
                    const resp = await fetch(`${SUPABASE_URL}/rest/v1/events`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON,
                            'Authorization': `Bearer ${SUPABASE_ANON}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(q.map(item => item.row)),
                        keepalive: true
                    });

                    if (!resp.ok) {
                        console.warn('Supabase upload failed', resp.status);
                        return; // keep queue for retry
                    }

                    localStorage.removeItem(UPLOAD_KEY);
                } catch (err) {
                    console.warn('Supabase upload network error', err);
                }
            }

            async function postEventToDB(evt) {
                if (!SUPABASE_URL || !SUPABASE_ANON ||
                    SUPABASE_URL.indexOf('supabase.co') === -1) return;

                const row = eventToRow(evt);
                const q = loadQueue();
                q.push({ row });
                saveQueue(q);
                await flushUploadQueue();
            }

            window.addEventListener('online', flushUploadQueue);
            setInterval(flushUploadQueue, 10000);

            /* ---------- Unified logging ---------- */

            function stream(e) {
                if (!e.session_id) {
                    e.session_id = session.session_id;
                }
                if (!e.ts) {
                    e.ts = Date.now();
                }

                // Local mirror for debugging if you ever need it
                const arr = load('exp_events', []);
                arr.push({ type: 'event', ...e });
                save('exp_events', arr);

                postEventToDB(e);
            }

            /* ---------- Transcript randomization ---------- */

            function uniquePerms(ms) {
                const map = {};
                ms.forEach(x => map[x] = (map[x] || 0) + 1);
                const keys = Object.keys(map), res = [];

                function bt(p) {
                    if (p.length === ms.length) {
                        res.push(p.slice());
                        return;
                    }
                    for (const k of keys) {
                        if (map[k] > 0) {
                            map[k]--;
                            p.push(k);
                            bt(p);
                            p.pop();
                            map[k]++;
                        }
                    }
                }
                bt([]);
                const seen = new Set(), out = [];
                for (const p of res) {
                    const s = p.join('');
                    if (!seen.has(s)) {
                        seen.add(s);
                        out.push(p);
                    }
                }
                return out;
            }

            const ALPHA_ROWS = uniquePerms(['A', 'A', 'A', 'B', 'B']);
            const BETA_ROWS = uniquePerms(['A', 'A', 'B', 'B', 'B']);

            function routes() {
                const t = ['A', 'B'], r = [];
                for (const i of t) for (const j of t) for (const k of t) r.push(i + j + k);
                return r;
            }

            const CASES = shuffle(routes()).slice(0, state.casesCount);
            let caseIdx = 0, transIdx = 0, caseStart = 0, transStart = 0, routeCode = null;
            let currentSlider = state.caseSliderDefault;

            /* ---------- Flow: intro → consent → experiment ---------- */

            function startIntro() {
                const ctr = document.createElement('div');
                ctr.className = 'center';
                app.innerHTML = '';
                app.appendChild(ctr);
                fadeLines(ctr, state.introLines, () => {
                    const b = el('button', { class: 'btn primary' }, ['Continue']);
                    b.onclick = showConsent;
                    ctr.appendChild(b);
                });
            }

            function showConsent() {
                app.innerHTML = '';
                const box = el('div', { class: 'card' }, [
                    el('h2', {}, ['Consent to Participate']),
                    el('p', {}, ['Your responses will be uploaded for research use in real time.']),
                    el('p', {}, ['You can stop at any time.']),
                    el('div', { class: 'btn-row' }, [
                        el('button', { id: 'acc', class: 'btn primary' }, ['Accept']),
                        el('button', { id: 'deny', class: 'btn' }, ['Decline'])
                    ])
                ]);
                const ctr = el('div', { class: 'center' }, [box]);
                app.appendChild(ctr);

                box.querySelector('#acc').onclick = () => {
                    session.upload_consent = true;
                    stream({
                        name: 'consent_accept',
                        session_id: session.session_id,
                        ts: Date.now()
                    });
                    startExperiment();
                };
                box.querySelector('#deny').onclick = () => {
                    session.upload_consent = false;
                    stream({
                        name: 'consent_decline',
                        session_id: session.session_id,
                        ts: Date.now()
                    });
                    app.innerHTML = '<div class="center"><h2>Thank you for your time.</h2></div>';
                };
            }

            function startExperiment() {
                // log basic session meta
                stream({
                    name: 'session_meta',
                    session_id: session.session_id,
                    ts: session.started_ts,
                    channel,
                    prolific_id
                });

                const un = mask('Preparing Case 1…');
                setTimeout(() => { un(); nextCase(); },
                    rand(state.maskMsMin, state.maskMsMax));
            }

            function showTranscript(type, onCommit) {
                app.innerHTML = '';
                const row = (type === 'A')
                    ? ALPHA_ROWS[Math.floor(Math.random() * ALPHA_ROWS.length)]
                    : BETA_ROWS[Math.floor(Math.random() * BETA_ROWS.length)];

                const frame = el('div', { class: 'card focus' });
                frame.appendChild(el('div', { class: 'subhead' }, ['Semester ', ['X', 'Y', 'Z'][transIdx]]));
                frame.appendChild(el('div', { class: 'grades' }, [row.join('   ')]));
                frame.appendChild(el('hr'));
                frame.appendChild(sliderRow(currentSlider, v => onCommit({ v, row })));

                app.appendChild(el('div', { class: 'center' }, [
                    el('h2', {}, ['Case ' + (caseIdx + 1) + ' — Transcript ' + (transIdx + 1) + '/3']),
                    frame
                ]));
            }

            function nextTranscript() {
                if (transIdx >= 3) {
                    const caseTime = Date.now() - caseStart;
                    stream({
                        name: 'case_end',
                        session_id: session.session_id,
                        ts: Date.now(),
                        case_index: caseIdx + 1,
                        route_code: routeCode,
                        case_time_ms: caseTime
                    });
                    caseIdx++;
                    const un = mask('Loading next case…');
                    setTimeout(() => { un(); nextCase(); },
                        rand(state.maskMsMin, state.maskMsMax));
                    return;
                }

                const type = routeCode[transIdx];
                transStart = Date.now();
                showTranscript(type, ({ v, row }) => {
                    const t = Date.now() - transStart;
                    currentSlider = v;
                    stream({
                        name: 'transcript_commit',
                        session_id: session.session_id,
                        ts: Date.now(),
                        case_index: caseIdx + 1,
                        within_case_index: transIdx + 1,
                        route_code: routeCode,
                        transcript_type: type,
                        letters_shown_order: row,
                        slider_value: v,
                        transcript_time_ms: t
                    });
                    transIdx++;
                    nextTranscript();
                });
            }

            function nextCase() {
                if (caseIdx >= state.casesCount) {
                    finish();
                    return;
                }
                routeCode = CASES[caseIdx];
                transIdx = 0;
                caseStart = Date.now();
                currentSlider = state.caseSliderDefault;

                stream({
                    name: 'case_start',
                    session_id: session.session_id,
                    ts: caseStart,
                    case_index: caseIdx + 1,
                    route_code: routeCode
                });

                nextTranscript();
            }

            function finish() {
                session.finished = true;
                stream({
                    name: 'session_finish',
                    session_id: session.session_id,
                    ts: Date.now(),
                    finished: true
                });
                app.innerHTML =
                    '<div class="center"><h2>All cases complete.</h2><div class="muted">You may now close this window.</div></div>';
            }

            // Kick off
            startIntro();
        })();
    </script>
</body>
</html>
